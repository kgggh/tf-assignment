# **프로젝트 개요**
이 프로젝트는 주문을 등록하는 API를 구현하는 것이 목표이며, 단건 주문과 엑셀을 통한 대량 주문 등록 기능을 포함하고 있습니다.  
특히, **동시 주문이 발생했을 때 데이터 정합성을 유지하기 위해 분산락을 적용하는 것**이 핵심입니다.

---

## **1. 프로젝트 환경**
- **Java:** 17
- **Framework:** Spring Boot 3.4.2
- **Database:** H2

---

## **2. 사용 라이브러리 및 목적**

| 라이브러리                          | 목적                                              |
|--------------------------------|-------------------------------------------------|
| **Apache POI**                 | 엑셀 파일(.xlsx, .xls)을 읽고 주문 데이터를 추출하는 기능을 제공      |
| **Redisson**                   | Redis 기반의 분산락을 활용하여 **동시 주문 발생 시 데이터 정합성 보장**   |
| **Spring Boot Docker Compose** | **테스트 환경에서 DB, Redis 등을 컨테이너 기반으로 실행하여 일관된 환경 제공** |

---

## **3. 설계 및 구조**
-  ERD: [./images/erd.jpg](./images/erd.jpg)

### **1) 주문 등록 프로세스**
- 요청이 들어오면 **락을 먼저 획득한 후, 상품 정보를 조회하고 재고를 확인한 뒤 주문을 생성하는 방식**으로 동작합니다.
- 여러 사용자가 동시에 주문을 요청하는 경우를 고려하여 **분산락을 적용**하였으며, **락을 최소한의 범위로 적용하여 성능 저하를 방지**하였습니다.
- 주문 생성 과정에서 **상품 정보를 조회하기 전에 락을 획득하여, 다중 쓰레드 환경에서도 데이터 정합성을 유지**하도록 설계하였습니다.

### **2) 동시성 제어와 데이터 정합성**
- 같은 상품을 여러 사용자가 동시에 주문하는 경우, **정확한 재고 관리를 위해 분산락을 적용**하여 데이터 정합성을 유지합니다.

### **3) Redisson의 `multiLock()`을 활용한 락 최적화**
- 기존에는 상품별로 개별적으로 락을 획득하는 방식으로 진행했으나, 테스트를 진행 하다보니 **다중 상품 주문 시 락을 하나씩 획득하는 방식이 성능 저하를 초래할 가능성이 있었습니다.**
- 이를 해결하기 위해 **Redisson의 `multiLock()`을 적용하여 여러 상품에 대한 락을 한 번에 획득**하도록 변경하였습니다.
- 이 방식은 **상품 정보를 조회하기 전에 락을 설정하여 데이터 정합성을 유지하고, 여러 개의 상품을 포함한 주문에서도 락을 일괄적으로 처리하여 성능을 최적화**할 수 있습니다.

### **4) 파일을 통한 주문 등록**
- 단건 주문뿐만 아니라 **엑셀 파일을 통해 여러 건의 주문을 한 번에 처리할 수 있도록 설계**하였습니다.
- 파일을 처리하는 부분과 주문을 생성하는 부분을 분리하여, **새로운 파일 포맷이 추가되더라도 기존 로직을 수정하지 않도록 확장성을 고려**하였습니다.
- 이를 위해 **전략 패턴을 적용하여 파일 포맷별로 다른 처리 로직을 유연하게 적용할 수 있도록 설계**하였습니다.
  - 확장자가 `.xlsx`인 경우 엑셀 처리 전략을 적용하고,
  - CSV, TXT 등 다른 포맷이 추가될 경우에도 **새로운 전략을 추가하는 것만으로 기능 확장이 가능하도록 구조를 설계**하였습니다.

### **5) 재고 차감 설계**
- **재고 관리 관점에서 설계되지 않았으며, 단순히 주문 생성 시 상품 재고가 차감되는 방식으로 설계했습니다.**
- 주문 테이블을 통해 **어떤 상품이 얼마만큼 주문되었는지 확인할 수 있어, 추가적인 데이터 저장 없이 재고 변화를 추적할 수 있습니다.**
- 현재 요구사항을 기준으로 **주문 취소, 반품 등의 재고 복구 기능은 포함하지 않았으며, 별도의 로그성 테이블(재고 변동 이력 테이블)도 생성하지 않았습니다.**

---

## **4. 테스트 진행 항목**

### 주문 생성 테스트
| 테스트 항목 | 설명 |
|------------|---------------------------------------------|
| **단건 주문 생성** | 정상적인 주문 요청이 들어왔을 때 주문이 정상적으로 처리되는지 검증합니다. |
| **재고 부족 시 주문 실패** | 주문 수량이 재고보다 많을 경우, 주문이 거부되는지 확인합니다. |
| **존재하지 않는 상품 주문 시 실패** | 상품 ID가 유효하지 않을 경우, 주문이 실패하는지 검증합니다. |

### 엑셀 기반 주문 테스트
| 테스트 항목 | 설명 |
|------------|---------------------------------------------|
| **엑셀 주문 정상 처리** | 엑셀 파일을 통한 주문 등록이 정상적으로 수행되는지 검증합니다. |
| **엑셀 내 존재하지 않는 상품 주문 시 실패** | 엑셀 파일 내 일부 상품이 존재하지 않는 경우, 오류가 발생하는지 확인합니다. |
| **엑셀 내 재고 부족 상품 포함 시 실패** | 일부 상품의 재고가 부족한 경우, 주문이 실패하는지 검증합니다. |

### 동시성 및 분산 환경 테스트
| 테스트 항목 | 설명 |
|------------|---------------------------------------------|
| **동시에 여러 주문이 들어올 때 정상 처리 여부** | 다수의 요청이 동시에 들어올 때, 분산락이 올바르게 동작하고 재고가 정상적으로 차감되는지 검증합니다. |
| **동시 주문 중 일부 재고 부족 시 실패 처리** | 여러 개의 주문 요청이 동시에 들어오고, 일부 요청이 재고 부족으로 실패할 경우 나머지 요청은 정상적으로 처리되는지 확인합니다. |

---

## **5. 진행 중 이슈사항**
### 1. Java 21 → Java 17 다운그레이드
- 특정 패키지에서 발생한 버그로 인해 **Java 17로 다운그레이드하여 정상적으로 동작 확인**
- 참고: [IntelliJ 특정 버전 JDK 21 사용 시 컴파일 오류 관련 포스팅](https://gnnny.tistory.com/entry/IntelliJ-%ED%8A%B9%EC%A0%95-%EB%B2%84%EC%A0%84-JDK-21-%EC%82%AC%EC%9A%A9-%EC%8B%9C-%EC%BB%B4%ED%8C%8C%EC%9D%BC-%EC%98%A4%EB%A5%98)
### 2. 트랜잭션 내부 락 획득으로 인한 재고 차감 문제
- 초기에는 트랜잭션 내부에서 락을 획득하여 재고 차감이 정상적으로 반영되지 않는 문제가 발생하였음.
- 이를 해결하기 위해 트랜잭션 시작 전에 락을 먼저 획득하는 방식으로 변경하여 데이터 정합성을 보장함.
- 락을 먼저 잡고 상품을 조회하는 방식으로 개선하여, 동시성 이슈를 최소화하고 불필요한 락 경합을 방지함.
